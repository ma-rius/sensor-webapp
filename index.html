<!doctype html>
<html>
<head>
    <!--  Own CSS-->
    <link rel="stylesheet" href="css/main.css">
    <!--  Bootstrap CSS-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!--    jQuery & Bootstrap JS-->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>

    <!--    require.js-->
    <script src="js/require.js"></script>

    <title>Sensor Classification</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

</head>
<body>

<br/>

<div class="container">
    <div class="row"></div>
    <div class="col-sm">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home"
                   aria-selected="true">Use App</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab"
                   aria-controls="profile" aria-selected="false">Record new data</a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                ...
            </div>
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <form>
                    <b>Record:</b><br>
                    <label class="switch">
                        <input type="checkbox" id="record">
                        <div class="slider round"></div>
                    </label>
                    <br/>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text" for="label">Label</label>
                        </div>
                        <select class="custom-select" id="label">
                            <!--                            <option selected>Choose...</option>-->
                            <option selected value="running">Running</option>
                            <option value="walking">Walking</option>
                        </select>
                    </div>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="inputGroup-sizing-default">Name</span>
                        </div>
                        <input type="text" id="subject" class="form-control" aria-label="Sizing example input"
                               aria-describedby="inputGroup-sizing-default" value="Marius">
                    </div>
                </form>
                <p id="debug"><br></p>
                <p id="orientation_alpha"><br></p>
                <p id="orientation_beta"><br></p>
                <p id="orientation_gamma"><br></p>
                <p id="acceleration_x"><br></p>
                <p id="acceleration_y"><br></p>
                <p id="acceleration_z"></p>
            </div>

        </div>
    </div>
</div>
<!--<script>-->

<!--    window.addEventListener('devicemotion', function (event) {-->
<!--            document.getElementById("sensor").innerHTML = "Acceleration" + event.acceleration.y + "<br>";-->
<!--            // console.log(event);-->
<!--        }-->
<!--    );-->

<!--    window.addEventListener('deviceorientation', function (event) {-->
<!--        document.getElementById("orientation").innerHTML = "Orientation: " + event.orientation_alpha + "<br>";-->
<!--        // document.getElementById("orientation").innerHTML = window.DeviceOrientationEvent;-->
<!--    });-->

<!--    // if ('ondevicelight' in window) {-->
<!--    //     window.addEventListener('devicelight', function(event) {-->
<!--    //         document.getElementById("light").innerHTML = "Light: " + event.value;-->
<!--    //     });-->
<!--    // } else {-->
<!--    //     console.log('devicelight event not supported');-->
<!--    // }-->

<!--    // var influent = require(['js/influent']);-->

<!--    require(["js/influent"], function (influent) {-->
<!--        influent-->
<!--            .createHttpClient({-->
<!--                server: [-->
<!--                    {-->
<!--                        protocol: "https",-->
<!--                        host: "193.196.37.63",-->
<!--                        port: 8086-->
<!--                    }-->
<!--                ],-->
<!--                username: "",-->
<!--                password: "",-->

<!--                database: "db0"-->
<!--            })-->
<!--            .then(function (client) {-->
<!--                client-->
<!--                    .query("show databases")-->
<!--                    .then(function (result) {-->
<!--                       console.log(result);-->
<!--                    });-->

<!--                // super simple point-->
<!--                // client.write_orientation({key: "myseries", value: 10});-->

<!--                // more explicit point-->
<!--                client-->
<!--                    .write_orientation({-->
<!--                        key: "myseries",-->
<!--                        tags: {-->
<!--                            some_tag: "sweet"-->
<!--                        },-->
<!--                        fields: {-->
<!--                            some_field: 10-->
<!--                        },-->
<!--                        timestamp: Date.now()-->
<!--                    })-->
<!--                    .then(function () {-->
<!--                        // ...-->
<!--                    });-->
<!--            });-->
<!--    });-->
<!--</script>-->

<script>

    // Global variables to store current values.
    var orientation_buf;
    var acceleration_buf;

    //make constructor to easily initiallize all arrays
    function OrientationValues() {
        return {
            orientation_alpha: [],
            orientation_beta: [],
            orientation_gamma: [],
        }
    }

    function AccelerationValues() {
        return {
            acceleration_x: [],
            acceleration_y: [],
            acceleration_z: [],
        }
    }

    orientation_buf = new OrientationValues(); // start empty
    acceleration_buf = new AccelerationValues(); // start empty

    // How many data points are uploaded per second?
    var UPLOAD_RATE = 20;

    // only created if client below is _not_ instantiated successfully
    var write_orientation = function () {
        document.getElementById("debug").innerHTML = "DataBase not Connected!!"
    };

    var write_acceleration = function () {
        document.getElementById("debug").innerHTML = "DataBase not Connected!!"
    };

    // var writePoint = function () {
    //     noWrite()
    // } //do not pass object reference otherwise noWrite might get overwritten ?!?

    // Stop/Start uploading depending on switch.
    var interval_orientation; // Global var for setInterval setting/clearing.
    var interval_acceleration;

    document.getElementById('record').onchange = function () {
        if (this.checked) {
            label = document.getElementById("label").value;
            subject = document.getElementById("subject").value;
            // writePoint = function () {
            //     write_orientation()
            // };

            if (isNaN(subject)) {
                window.clearInterval(interval_acceleration);
                window.clearInterval(interval_orientation);

                // Write DeviceOrientation to buffer
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', function (orientation) {
                        if (!isNaN(orientation.alpha)) {
                            orientation_buf.orientation_alpha.push(orientation.alpha);
                        }
                        if (!isNaN(orientation.beta)) {
                            orientation_buf.orientation_beta.push(orientation.beta);
                        }
                        if (!isNaN(orientation.gamma)) {
                            orientation_buf.orientation_gamma.push(orientation.gamma);
                        }
                    }, false);
                    interval_orientation = window.setInterval(write_orientation, 1000 / UPLOAD_RATE);
                } else {
                    document.getElementById("debug").innerHTML = "DeviceOrientation not supported."
                }

                // Write Acceleration to buffer
                if (window.DeviceMotionEvent) {
                    window.addEventListener('devicemotion', function (acceleration) {
                        if (!isNaN(acceleration.acceleration.x)) {
                            acceleration_buf.acceleration_x.push(acceleration.acceleration.x);
                        }
                        if (!isNaN(acceleration.acceleration.y)) {
                            acceleration_buf.acceleration_y.push(acceleration.acceleration.y);
                        }
                        if (!isNaN(acceleration.acceleration.y)) {
                            acceleration_buf.acceleration_z.push(acceleration.acceleration.z);
                        }
                    }, false);
                    interval_acceleration = window.setInterval(write_acceleration, 1000 / UPLOAD_RATE);
                } else {
                    document.getElementById("debug").innerHTML = "DeviceMotion not supported."
                }

            } else {
                this.checked = false;
                document.getElementById("debug").innerHTML = "Enter name first."
            }

        } else {
            window.clearInterval(interval_orientation);
            window.clearInterval(interval_acceleration);
            write_orientation();
            write_acceleration();
            document.getElementById("debug").innerHTML = "Not recording."
        }
    };

    //use "bower install requirejs influent"
    require(["js/influent"], function (influent) {
        influent
            .createHttpClient({
                server: [
                    {
                        protocol: "https",
                        host: "193.196.37.63",
                        port: 8086
                    }
                ],
                username: "admin",
                password: "admin",

                database: "db0"
            })
            .then(function (client) {
                //set the write_orientation function to empty our buffer (called periodically, see above)
                write_orientation = function () {
                    // console.log(orientation_buf);
                    if (orientation_buf.orientation_alpha.length > 0) {
                        // console.log('succes');
                        var v = orientation_buf; //copy old buffer to var to avoid async effects on write_orientation
                        orientation_buf = new OrientationValues(); // reset buffer

                        function milli_mean_int(values) {
                            var sum = values.reduce(function (a, b) {
                                return a + b;
                            });
                            return Math.floor(sum * 1000 / values.length);
                        }

                        client.write({
                            key: "orientation_b",
                            tags: {
                                label: document.getElementById("label").value,
                                subject: document.getElementById("subject").value
                            },
                            fields: {
                                orientation_alpha: milli_mean_int(v.orientation_alpha), //use mean * 1000 (int for efficiency)
                                orientation_beta: milli_mean_int(v.orientation_beta),
                                orientation_gamma: milli_mean_int(v.orientation_gamma),
                            },
                            timestamp: Date.now() * 1000000 // JavaScript records time in milliseconds, so you won't be able to get time to that precision. The smart-aleck answer is to "multiply by 1,000,000".
                        }).then(function () {
                            document.getElementById("orientation_alpha").innerHTML = "orientation_alpha: " + v.orientation_alpha
                        });
                    }
                };

                write_acceleration = function () {
                    // console.log('bbbb');
                    if (acceleration_buf.acceleration_x.length > 0) {
                        var v = acceleration_buf; //copy old buffer to var to avoid async effects on write_orientation
                        acceleration_buf = new AccelerationValues(); // reset buffer

                        function milli_mean_int(values) {
                            var sum = values.reduce(function (a, b) {
                                return a + b;
                            });
                            return Math.floor(sum * 1000 / values.length);
                        }
                        client.write({
                            key: "acceleration",
                            tags: {
                                label: document.getElementById("label").value,
                                subject: document.getElementById("subject").value
                            },
                            fields: {
                                acceleration_x: milli_mean_int(v.acceleration_x),
                                acceleration_y: milli_mean_int(v.acceleration_y),
                                acceleration_z: milli_mean_int(v.acceleration_z),
                            },
                            timestamp: Date.now() * 1000000 // JavaScript records time in milliseconds, so you won't be able to get time to that precision. The smart-aleck answer is to "multiply by 1,000,000".
                        }).then(function () {
                            document.getElementById("acceleration_x").innerHTML = "acceleration_x: " + v.acceleration_x
                        });
                    }
                };

            })
    })

</script>
</body>
</html>
